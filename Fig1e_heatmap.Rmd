---
title: "Fig1_heatmap"
author: "Qiuyun Yang"
date: "`r Sys.Date()`"
output: html_document
---

#heatmap
load("D:/R/TCF7L1/immune.combined.sct.named.RData")
load("D:/R/TCF7L1/degs.normalize.Rdata")
degs_sig <- degs.normalize %>% 
  filter(pct.1 > 0.3 & p_val < 0.05) %>%
  filter(cluster != "other") %>%
  arrange(cluster,-avg_log2FC) 

degs_top <- degs_sig %>% 
  filter(cluster!="other") %>%
  group_by(cluster) %>% 
  arrange(cluster, -avg_log2FC)

avgData <- immune.combined.sct@assays$RNA@data[degs_top$gene,] %>% 
  apply(1, function(x){
    tapply(x, immune.combined.sct$celltype, mean) 
  }) %>% t

phData <- MinMax(scale(avgData), -2, 2) # z-score
rownames(phData) <- 1:nrow(phData)
library(pheatmap)
phres <- pheatmap(
  phData, 
  color = colorRampPalette(c("darkblue", "white", "red3"))(99), 
  scale = "row",
  cluster_rows = F, 
  cluster_cols = F, 
  clustering_method = "complete",
  show_rownames = F, 
  annotation_row = data.frame(cluster = degs_top$cluster)
)  
write.csv(degs_top, file = "degs_top.csv")
